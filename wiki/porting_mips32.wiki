#summary Success story: porting uOS to Elvees Multicore MIPS32 architecture

= Микроконтроллеры Элвис Мультикор =
Описана последовательность работ по переносу системы uOS на архитектуру [http://www.mips.com/products/processors/architectures/mips32/ MIPS32],
применительно к микроконтроллеру [http://multicore.ru/index.php?id=47 MC-24] семейства Элвис Мультикор.

Скалярное ядро процессоров Элвис Мультикор имеет архитектуру MIPS32,
которая пока не поддерживается операционной системой uOS.
В первую очередь требуется реализация машинно-зависимой части микроядра для архитектуры
MIPS32. Затем необходимо реализовать работу с периферийными устройствами:
инициализацию, таймер, UART и т.д.

=== 1. Создаём каталог целевой платформы ===
Создаем каталог uos/targets/mc24. Помещаем туда файлы, необходимые для компиляции.
{{{
mkdir uos/targets/mc24
cd uos/targets/mc24
cp ../s3c4530/Makefile .
cp ../s3c4530/target.cfg .
cp ../s3c4530/ldscript.x .
}}}

В файле target.cfg изменяем значения переменных:
  * ARCH - mips32.
  * MODULES - необходимо убрать s3c4530.
  * CFLAGS - задаем тип платформы -DMIPS32 и модель конкретного микроконтроллера -DELVEES_MC24.
  * BINDIR - устанавливаем правильный путь к компилятору, в моём случае это /usr/local/mipsel432/bin.
  * CC, AR и прочие - устанавливаем имена компонентов компилятора: mipsel-elf32-gcc и т.п.
  * STARTUP - стартовый код разместим в файле startup-mc24.S.

В файле ldscript.x заменяем везде arm на mips,
а также в блоке MEMORY изменяем адреса и длины сегментов памяти:
  * Для text устанавливаем ORIGIN = 0xbfc00000, LENGTH = 2M
  * Для data устанавливаем ORIGIN = 0xb8000000, LENGTH = 32K

В сегменте .data после __data_start добавляем установку адреса для регистра $gp.
Поскольку в контроллере МС-24 имеется всего 32 килобайта внутренней памяти,
смещение на 0x8000 не требуется:
{{{
_gp = .;
}}}

=== 2. Проектируем структуру контекста ===

Определяем количество и порядок регистров, сохраняемых в стеке при входе в прерывание или исключение. [arch_mips_notes Документируем] на будущее.

=== 3. Создаём файл описания специальных регистров процессора ===

Создаём каталог uos/sources/runtime/mips32 и в нём include-файл io.h с описанием регистров платформы MIPS32. Для конкретного процессора МС-24 делаем отдельный файл io-mc24.h. Файл io.h имеет вид:
{{{
#ifdef ELVEES_MC24
#   include <runtime/mips32/io-mc24.h>
#endif
}}}
В дальнейшем сюда можно добавлять варианты для других процессоров с архитектурой MIPS32.

=== 4. Создаём стартовый файл ===

Создаём стартовый файл startup-mc24.S. Стартовый код размещаем в секции .init, которая будет находиться по адресу 0xbfc00000. Вектора прерываний:
  * bfc00000 - аппаратный сброс, немаскируемое прерывание. Вызов Си-функции `_init_()`.
  * bfc00200 - обращение к отсутствующей странице. Сохранение регистров в стеке и вызов Си-функции `_pagefault_handler_(context)`.
  * bfc00380 - исключение. Сохранение регистров в стеке и вызов Си-функции `_exception_handler_(context)`.
  * bfc00400 - прерывание. Сохранение регистров в стеке и вызов Си-функции `_interrupt_handler_(context)`.
Здесь `int *context` указывает на массив из 32-х сохранённых регистров.

... TODO ...

=== 2. Создаем файлы заголовков для AT91SAM ===
Добавляем файлы заголовков для всех моделей семейства SAM: от `at91sam7a3.h`
до `at91sam9xe512.h`. Эти файлы можно переписать из каталога
"C:\Program Files\AT91-ISP v1.9\SAM-BA v2.5\monitors\" после установки
пакета "Install AT91-ISP v1.9.exe". Размещаем их в каталоге
uos/sources/runtime/arm/. Для удобства переименовываем строчными буквами.

Создаем файл uos/sources/runtime/arm/io-at91sam.h:
{{{
#ifdef ARM_AT91SAM7A3
#include <runtime/arm/at91sam7a3.h>
#endif
#ifdef ARM_AT91SAM7S128
#include <runtime/arm/at91sam7s128.h>
#endif
... и так далее ...
}}}

В файле uos/sources/runtime/arm/io.h добавляем строки:
{{{
#ifdef ARM_AT91SAM
#include <runtime/arm/io-at91sam.h>
#endif
}}}

=== 3. Инициализируем начальное состояние микроконтроллера ===
В файле uos/sources/runtime/arm/init.c в функции `_init_()` добавляем
код инициализации начального состояния регистров микроконтроллера.
Заключаем его в #ifdef ARM_AT91SAM ... #endif.

=== 4. Делаем функции отладочной выдачи на консоль ===
В файле uos/sources/runtime/arm/debug.c добавляем функции отладочной
выдачи на консоль: `debug_putchar()`, `debug_getchar()`, `debug_peekchar()`.
Заключаем их в #ifdef ARM_AT91SAM ... #endif.

=== 5. Добавляем обработку прерываний ===
В файле uos/sources/kernel/arm/machdep.c в функциях `_irq_handler_()` и
`arm_intr_allow()` добавляем работу с регистрами контроллера прерываний.
Заключаем его в #ifdef ARM_AT91SAM ... #endif.

=== 6. Обрабатываем таймер ===
В файле uos/sources/timer/timer.c добавляем инициализацию регистров таймера.