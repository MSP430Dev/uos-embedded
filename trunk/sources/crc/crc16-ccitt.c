#include <runtime/lib.h>
#include <crc/crc16-ccitt.h>

/*
 * Define USE_8BIT_OPS, if your target processor
 * executes 8-bit ops faster than 16-bit ones.
 */

/*
 * Checksum lookup table, from RFC-1662.
 * CRC-CCITT = x^16 + x^12 + x^5 + 1
 */
#if defined (USE_8BIT_OPS) || defined (__AVR__)
static const unsigned char poly_tab [512] = {
	0x00,	0x89,	0x12,	0x9b,	0x24,	0xad,	0x36,	0xbf,
	0x48,	0xc1,	0x5a,	0xd3,	0x6c,	0xe5,	0x7e,	0xf7,
	0x81,	0x08,	0x93,	0x1a,	0xa5,	0x2c,	0xb7,	0x3e,
	0xc9,	0x40,	0xdb,	0x52,	0xed,	0x64,	0xff,	0x76,
	0x02,	0x8b,	0x10,	0x99,	0x26,	0xaf,	0x34,	0xbd,
	0x4a,	0xc3,	0x58,	0xd1,	0x6e,	0xe7,	0x7c,	0xf5,
	0x83,	0x0a,	0x91,	0x18,	0xa7,	0x2e,	0xb5,	0x3c,
	0xcb,	0x42,	0xd9,	0x50,	0xef,	0x66,	0xfd,	0x74,
	0x04,	0x8d,	0x16,	0x9f,	0x20,	0xa9,	0x32,	0xbb,
	0x4c,	0xc5,	0x5e,	0xd7,	0x68,	0xe1,	0x7a,	0xf3,
	0x85,	0x0c,	0x97,	0x1e,	0xa1,	0x28,	0xb3,	0x3a,
	0xcd,	0x44,	0xdf,	0x56,	0xe9,	0x60,	0xfb,	0x72,
	0x06,	0x8f,	0x14,	0x9d,	0x22,	0xab,	0x30,	0xb9,
	0x4e,	0xc7,	0x5c,	0xd5,	0x6a,	0xe3,	0x78,	0xf1,
	0x87,	0x0e,	0x95,	0x1c,	0xa3,	0x2a,	0xb1,	0x38,
	0xcf,	0x46,	0xdd,	0x54,	0xeb,	0x62,	0xf9,	0x70,
	0x08,	0x81,	0x1a,	0x93,	0x2c,	0xa5,	0x3e,	0xb7,
	0x40,	0xc9,	0x52,	0xdb,	0x64,	0xed,	0x76,	0xff,
	0x89,	0x00,	0x9b,	0x12,	0xad,	0x24,	0xbf,	0x36,
	0xc1,	0x48,	0xd3,	0x5a,	0xe5,	0x6c,	0xf7,	0x7e,
	0x0a,	0x83,	0x18,	0x91,	0x2e,	0xa7,	0x3c,	0xb5,
	0x42,	0xcb,	0x50,	0xd9,	0x66,	0xef,	0x74,	0xfd,
	0x8b,	0x02,	0x99,	0x10,	0xaf,	0x26,	0xbd,	0x34,
	0xc3,	0x4a,	0xd1,	0x58,	0xe7,	0x6e,	0xf5,	0x7c,
	0x0c,	0x85,	0x1e,	0x97,	0x28,	0xa1,	0x3a,	0xb3,
	0x44,	0xcd,	0x56,	0xdf,	0x60,	0xe9,	0x72,	0xfb,
	0x8d,	0x04,	0x9f,	0x16,	0xa9,	0x20,	0xbb,	0x32,
	0xc5,	0x4c,	0xd7,	0x5e,	0xe1,	0x68,	0xf3,	0x7a,
	0x0e,	0x87,	0x1c,	0x95,	0x2a,	0xa3,	0x38,	0xb1,
	0x46,	0xcf,	0x54,	0xdd,	0x62,	0xeb,	0x70,	0xf9,
	0x8f,	0x06,	0x9d,	0x14,	0xab,	0x22,	0xb9,	0x30,
	0xc7,	0x4e,	0xd5,	0x5c,	0xe3,	0x6a,	0xf1,	0x78,

	0x00,	0x11,	0x23,	0x32,	0x46,	0x57,	0x65,	0x74,
	0x8c,	0x9d,	0xaf,	0xbe,	0xca,	0xdb,	0xe9,	0xf8,
	0x10,	0x01,	0x33,	0x22,	0x56,	0x47,	0x75,	0x64,
	0x9c,	0x8d,	0xbf,	0xae,	0xda,	0xcb,	0xf9,	0xe8,
	0x21,	0x30,	0x02,	0x13,	0x67,	0x76,	0x44,	0x55,
	0xad,	0xbc,	0x8e,	0x9f,	0xeb,	0xfa,	0xc8,	0xd9,
	0x31,	0x20,	0x12,	0x03,	0x77,	0x66,	0x54,	0x45,
	0xbd,	0xac,	0x9e,	0x8f,	0xfb,	0xea,	0xd8,	0xc9,
	0x42,	0x53,	0x61,	0x70,	0x04,	0x15,	0x27,	0x36,
	0xce,	0xdf,	0xed,	0xfc,	0x88,	0x99,	0xab,	0xba,
	0x52,	0x43,	0x71,	0x60,	0x14,	0x05,	0x37,	0x26,
	0xde,	0xcf,	0xfd,	0xec,	0x98,	0x89,	0xbb,	0xaa,
	0x63,	0x72,	0x40,	0x51,	0x25,	0x34,	0x06,	0x17,
	0xef,	0xfe,	0xcc,	0xdd,	0xa9,	0xb8,	0x8a,	0x9b,
	0x73,	0x62,	0x50,	0x41,	0x35,	0x24,	0x16,	0x07,
	0xff,	0xee,	0xdc,	0xcd,	0xb9,	0xa8,	0x9a,	0x8b,
	0x84,	0x95,	0xa7,	0xb6,	0xc2,	0xd3,	0xe1,	0xf0,
	0x08,	0x19,	0x2b,	0x3a,	0x4e,	0x5f,	0x6d,	0x7c,
	0x94,	0x85,	0xb7,	0xa6,	0xd2,	0xc3,	0xf1,	0xe0,
	0x18,	0x09,	0x3b,	0x2a,	0x5e,	0x4f,	0x7d,	0x6c,
	0xa5,	0xb4,	0x86,	0x97,	0xe3,	0xf2,	0xc0,	0xd1,
	0x29,	0x38,	0x0a,	0x1b,	0x6f,	0x7e,	0x4c,	0x5d,
	0xb5,	0xa4,	0x96,	0x87,	0xf3,	0xe2,	0xd0,	0xc1,
	0x39,	0x28,	0x1a,	0x0b,	0x7f,	0x6e,	0x5c,	0x4d,
	0xc6,	0xd7,	0xe5,	0xf4,	0x80,	0x91,	0xa3,	0xb2,
	0x4a,	0x5b,	0x69,	0x78,	0x0c,	0x1d,	0x2f,	0x3e,
	0xd6,	0xc7,	0xf5,	0xe4,	0x90,	0x81,	0xb3,	0xa2,
	0x5a,	0x4b,	0x79,	0x68,	0x1c,	0x0d,	0x3f,	0x2e,
	0xe7,	0xf6,	0xc4,	0xd5,	0xa1,	0xb0,	0x82,	0x93,
	0x6b,	0x7a,	0x48,	0x59,	0x2d,	0x3c,	0x0e,	0x1f,
	0xf7,	0xe6,	0xd4,	0xc5,	0xb1,	0xa0,	0x92,	0x83,
	0x7b,	0x6a,	0x58,	0x49,	0x3d,	0x2c,	0x1e,	0x0f,
};
#else /* USE_8BIT_OPS */
static const unsigned short poly_tab [256] = {
	0x0000,	0x1189,	0x2312,	0x329b,	0x4624,	0x57ad,	0x6536,	0x74bf,
	0x8c48,	0x9dc1,	0xaf5a,	0xbed3,	0xca6c,	0xdbe5,	0xe97e,	0xf8f7,
	0x1081,	0x0108,	0x3393,	0x221a,	0x56a5,	0x472c,	0x75b7,	0x643e,
	0x9cc9,	0x8d40,	0xbfdb,	0xae52,	0xdaed,	0xcb64,	0xf9ff,	0xe876,
	0x2102,	0x308b,	0x0210,	0x1399,	0x6726,	0x76af,	0x4434,	0x55bd,
	0xad4a,	0xbcc3,	0x8e58,	0x9fd1,	0xeb6e,	0xfae7,	0xc87c,	0xd9f5,
	0x3183,	0x200a,	0x1291,	0x0318,	0x77a7,	0x662e,	0x54b5,	0x453c,
	0xbdcb,	0xac42,	0x9ed9,	0x8f50,	0xfbef,	0xea66,	0xd8fd,	0xc974,
	0x4204,	0x538d,	0x6116,	0x709f,	0x0420,	0x15a9,	0x2732,	0x36bb,
	0xce4c,	0xdfc5,	0xed5e,	0xfcd7,	0x8868,	0x99e1,	0xab7a,	0xbaf3,
	0x5285,	0x430c,	0x7197,	0x601e,	0x14a1,	0x0528,	0x37b3,	0x263a,
	0xdecd,	0xcf44,	0xfddf,	0xec56,	0x98e9,	0x8960,	0xbbfb,	0xaa72,
	0x6306,	0x728f,	0x4014,	0x519d,	0x2522,	0x34ab,	0x0630,	0x17b9,
	0xef4e,	0xfec7,	0xcc5c,	0xddd5,	0xa96a,	0xb8e3,	0x8a78,	0x9bf1,
	0x7387,	0x620e,	0x5095,	0x411c,	0x35a3,	0x242a,	0x16b1,	0x0738,
	0xffcf,	0xee46,	0xdcdd,	0xcd54,	0xb9eb,	0xa862,	0x9af9,	0x8b70,
	0x8408,	0x9581,	0xa71a,	0xb693,	0xc22c,	0xd3a5,	0xe13e,	0xf0b7,
	0x0840,	0x19c9,	0x2b52,	0x3adb,	0x4e64,	0x5fed,	0x6d76,	0x7cff,
	0x9489,	0x8500,	0xb79b,	0xa612,	0xd2ad,	0xc324,	0xf1bf,	0xe036,
	0x18c1,	0x0948,	0x3bd3,	0x2a5a,	0x5ee5,	0x4f6c,	0x7df7,	0x6c7e,
	0xa50a,	0xb483,	0x8618,	0x9791,	0xe32e,	0xf2a7,	0xc03c,	0xd1b5,
	0x2942,	0x38cb,	0x0a50,	0x1bd9,	0x6f66,	0x7eef,	0x4c74,	0x5dfd,
	0xb58b,	0xa402,	0x9699,	0x8710,	0xf3af,	0xe226,	0xd0bd,	0xc134,
	0x39c3,	0x284a,	0x1ad1,	0x0b58,	0x7fe7,	0x6e6e,	0x5cf5,	0x4d7c,
	0xc60c,	0xd785,	0xe51e,	0xf497,	0x8028,	0x91a1,	0xa33a,	0xb2b3,
	0x4a44,	0x5bcd,	0x6956,	0x78df,	0x0c60,	0x1de9,	0x2f72,	0x3efb,
	0xd68d,	0xc704,	0xf59f,	0xe416,	0x90a9,	0x8120,	0xb3bb,	0xa232,
	0x5ac5,	0x4b4c,	0x79d7,	0x685e,	0x1ce1,	0x0d68,	0x3ff3,	0x2e7a,
	0xe70e,	0xf687,	0xc41c,	0xd595,	0xa12a,	0xb0a3,	0x8238,	0x93b1,
	0x6b46,	0x7acf,	0x4854,	0x59dd,	0x2d62,	0x3ceb,	0x0e70,	0x1ff9,
	0xf78f,	0xe606,	0xd49d,	0xc514,	0xb1ab,	0xa022,	0x92b9,	0x8330,
	0x7bc7,	0x6a4e,	0x58d5,	0x495c,	0x3de3,	0x2c6a,	0x1ef1,	0x0f78,
};
#endif /* USE_8BIT_OPS */

/*
 * Calculate a new sum given the current sum and the new data.
 * Use 0xffff as the initial sum value.
 * Do not forget to invert the final checksum value.
 */
unsigned short
crc16_ccitt (unsigned short sum, unsigned const char *buf, unsigned short len)
{
#if __AVR__
	if (len) asm volatile (
	"1:	movw r30, %3 \n"	/* 1 clock */
	"	ld __tmp_reg__, %a0+ \n"/* 2 clocks */
	"	eor %A1, __tmp_reg__ \n"/* 1 clock */
	"	add r30, %A1 \n"	/* 1 clock */
	"	adc r31, __zero_reg__ \n"/* 1 clock */
	"	lpm %A1, Z \n"		/* 3 clocks */
	"	eor %A1, %B1 \n"	/* 1 clock */
	"	inc r31 \n"		/* 1 clock */
	"	lpm %B1, Z \n"		/* 3 clocks */
	"	sbiw %2, 1 \n"		/* 2 clock */
	"	brne 1b \n"		/* 2 clocks */
					/* total 18 clocks per byte */
	: "+e" (buf), "+r" (sum), "+w" (len)
	: "r" (poly_tab) : "r30", "r31", "cc", __tmp_reg__);

#elif defined (USE_8BIT_OPS)
	/* Using only 8-bit operations. */
	if (len) {
		unsigned char sum_low, sum_high, indx;

		sum_low = (unsigned char) sum;
		sum_high = (unsigned char) (sum >> 8);
		do {
			indx = *buf++ ^ sum_low;
			sum_low = sum_high ^ poly_tab [indx];
			sum_high = poly_tab [256 + indx];
		} while (len--);
		sum = sum_high << 8 | sum_low;
	}
#else
	/* Using 16-bit operations. */
	if (len) do
		sum = (sum >> 8) ^ poly_tab [*buf++ ^ (unsigned char) sum];
	while (--len);
#endif
	return sum;
}

unsigned short
crc16_ccitt_byte (unsigned short sum, unsigned char byte)
{
#if __AVR__
	const unsigned char *ptr = poly_tab;

	asm volatile (
	"	eor %A0, %2\n"		/* 1 clock */
	"	add r30, %A0 \n"	/* 1 clock */
	"	adc r31, __zero_reg__ \n"/* 1 clock */
	"	lpm %A0, Z \n"		/* 3 clocks */
	"	eor %A0, %B0 \n"	/* 1 clock */
	"	inc r31 \n"		/* 1 clock */
	"	lpm %B0, Z \n"		/* 3 clocks */
					/* total 11 clocks */
	: "+r" (sum), "+z" (ptr) : "r" (byte) : "cc");
#elif defined (USE_8BIT_OPS)
	/* Using only 8-bit operations. */
	unsigned char sum_low, sum_high, indx;

	sum_low = (unsigned char) sum;
	sum_high = (unsigned char) (sum >> 8);

	indx = byte ^ sum_low;
        sum_low = sum_high ^ poly_tab [indx];
        sum_high = poly_tab [256 + indx];

	sum = sum_high << 8 | sum_low;
#else
	/* Using 16-bit operations. */
	sum = (sum >> 8) ^ poly_tab [byte ^ (unsigned char) sum];
#endif
	return sum;
}

#ifdef DEBUG_CRC_CCITT
#include <stdio.h>

void test (unsigned const char *buf, unsigned char len)
{
	unsigned char i;
	unsigned short sum;

	for (i=0; i<len-2; ++i)
		printf ("%02x ", buf[i]);
	sum = crc16_ccitt (CRC16_CCITT_INIT, buf, len);
	printf ("(%02x %02x) - %04x", buf[len-2], buf[len-1], sum);
	if (sum == CRC16_CCITT_GOOD)
		printf (" - GOOD");
	printf ("\n");
}

int main ()
{
	unsigned char array [] = "\x10\x20\x00\x00";
	unsigned short sum;
	int i;

	test ("\x00\x00", 2);
	test ("\x07\x00", 2);
	test ("\x01\x00", 3);
	test ("\x02\x00", 3);
	test ("\x04\x00", 3);
	test ("\x08\x00", 3);
	test ("\x10\x00", 3);
	test ("\x20\x00", 3);
	test ("\x40\x00", 3);
	test ("\x80\x00", 3);

	test ("\x00\x01\x00", 4);
	test ("\x00\x02\x00", 4);
	test ("\x00\x04\x00", 4);
	test ("\x00\x08\x00", 4);
	test ("\x00\x10\x00", 4);
	test ("\x00\x20\x00", 4);
	test ("\x00\x40\x00", 4);
	test ("\x00\x80\x00", 4);

	test ("\x01\x00\x00", 4);
	test ("\x02\x00\x00", 4);
	test ("\x04\x00\x00", 4);
	test ("\x08\x00\x00", 4);
	test ("\x10\x00\x00", 4);
	test ("\x20\x00\x00", 4);
	test ("\x40\x00\x00", 4);
	test ("\x80\x00\x00", 4);

	test (array, 4);
	sum = ~crc16_ccitt (CRC16_CCITT_INIT, array, 2);
	array[2] = (unsigned char) sum;
	array[3] = (unsigned char) (sum >> 8);
	test (array, 4);

	sum = CRC16_CCITT_INIT;
	for (i=0; i<4; ++i)
		sum = crc16_ccitt_byte (sum, array[i]);
	for (i=0; i<2; ++i)
		printf ("%02x ", array[i]);
	printf ("(%02x %02x) - %04x", array[2], array[3], sum);
	if (sum == CRC16_CCITT_GOOD)
		printf (" - GOOD");
	printf ("\n");

	return 0;
}
#endif /* DEBUG_CRC_CCITT */
